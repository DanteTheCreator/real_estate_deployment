# Dockerfile for Multilingual Worker
# This creates a container specifically for running the multilingual processing worker

FROM python:3.11-slim

# Set environment variables
ENV PYTHONDONTWRITEBYTECODE=1 \
    PYTHONUNBUFFERED=1 \
    PYTHONPATH=/app

# Install system dependencies for compilation
RUN apt-get update && apt-get install -y \
    gcc \
    build-essential \
    && rm -rf /var/lib/apt/lists/*

# Set working directory
WORKDIR /app

# Copy requirements and install Python dependencies
COPY requirements.txt .
RUN pip install --no-cache-dir -r requirements.txt

# Copy the entire back-end directory (we need all modules for imports)
COPY . /app/

# Create logs directory and set permissions
RUN mkdir -p /app/logs

# Create startup script for multilingual worker
RUN echo '#!/bin/bash\n\
set -e\n\
echo "🌍 Starting ComfyRent Multilingual Worker..."\n\
echo "Configuration:"\n\
echo "  - Batch Size: ${BATCH_SIZE:-10}"\n\
echo "  - Check Interval: ${CHECK_INTERVAL:-300}s"\n\
echo "  - Mode: ${MODE:-new}"\n\
echo "  - Database Host: ${POSTGRES_HOST:-postgres}"\n\
echo "  - Multilingual Enabled: ${SCRAPER_CONCURRENT_LANGUAGES:-true}"\n\
echo ""\n\
cd /app\n\
exec python scraper/multilingual_worker.py "$@"' > /app/start-multilingual.sh && \
    chmod +x /app/start-multilingual.sh

# Create a non-root user for security
RUN useradd --create-home --shell /bin/bash worker
RUN chown -R worker:worker /app
USER worker

# Health check - check if multilingual worker process is running
HEALTHCHECK --interval=60s --timeout=15s --start-period=120s --retries=3 \
    CMD pgrep -f "python.*multilingual_worker.py" || exit 1

# Default environment variables
ENV BATCH_SIZE=10 \
    CHECK_INTERVAL=300 \
    MODE=new \
    SCRAPER_CONCURRENT_LANGUAGES=true

# Use the startup script as entrypoint
ENTRYPOINT ["/app/start-multilingual.sh"]
CMD ["--continuous", "--batch-size", "10", "--check-interval", "300"]
